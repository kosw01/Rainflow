<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainflow 알고리즘 계산 과정 설명</title>
    <style>
        body {
            font-family: 'Malgun Gothic', '맑은 고딕', Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-left: 5px solid #3498db;
            padding-left: 15px;
        }
        h3 {
            color: #555;
            margin-top: 20px;
        }
        .function-section {
            background-color: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step {
            background-color: #ecf0f1;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }
        .step-number {
            font-weight: bold;
            color: #2980b9;
            font-size: 1.1em;
        }
        .code-block {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        .code-block code {
            color: #ecf0f1;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .formula {
            background-color: #e8f4f8;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-size: 1.1em;
        }
        .note {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        ul {
            padding-left: 25px;
        }
        li {
            margin: 5px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Rainflow 알고리즘 계산 과정 설명</h1>
    
    <div class="function-section">
        <h2>1. sig2ext 함수 - 극값(Extrema) 추출</h2>
        <p>시간 신호에서 국소 극값(최대값과 최소값)을 찾는 함수입니다.</p>
        
        <div class="step">
            <div class="step-number">단계 1: 입력 신호 전처리</div>
            <ul>
                <li>입력 신호 <code>sig</code>를 1차원 배열로 변환</li>
                <li>샘플링 시간 <code>dt</code> 처리:
                    <ul>
                        <li>스칼라 값이면 그대로 사용</li>
                        <li>배열이면 신호 길이와 일치하는지 확인</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 2: 신호 양자화 (선택사항)</div>
            <ul>
                <li><code>clsn</code> 파라미터가 제공되면 신호를 양자화</li>
                <li>신호의 최대값과 최소값을 찾음</li>
                <li>신호를 지정된 클래스 수로 반올림하여 양자화</li>
                <li>목적: 노이즈 제거 및 극값 검출 정확도 향상</li>
            </ul>
            <div class="formula">
                양자화된 값 = round((신호값 - 최소값) × (클래스수-1) / (최대값 - 최소값)) × (최대값 - 최소값) / (클래스수-1) + 최소값
            </div>
        </div>

        <div class="step">
            <div class="step-number">단계 3: 극값 검출</div>
            <ul>
                <li>신호의 차분값 계산: <code>w1 = diff(sig)</code></li>
                <li>극값 마스크 생성:
                    <ul>
                        <li>첫 번째와 마지막 점은 항상 극값으로 간주</li>
                        <li>중간 점들은 이전 차분값과 다음 차분값의 부호가 다를 때 극값
                            <div class="formula">
                                극값 조건: (w1[i-1] × w1[i]) ≤ 0
                            </div>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 4: 극값 시간 계산</div>
            <ul>
                <li><code>dt</code>가 스칼라인 경우: <code>exttime = 극값 인덱스 × dt</code></li>
                <li><code>dt</code>가 배열인 경우: 극값 위치에 해당하는 시간 값 추출</li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 5: 연속된 동일값 제거</div>
            <ul>
                <li>3개 연속 동일값 제거: 중간값 삭제</li>
                <li>2개 연속 동일값 제거: 하나만 유지하고 시간은 중간값으로 조정</li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 6: 최종 극값 검증</div>
            <ul>
                <li>남은 극값들이 실제로 극값인지 재확인</li>
                <li>이전 차분값과 다음 차분값의 부호가 반대인지 확인</li>
            </ul>
        </div>

        <div class="note">
            <strong>반환값:</strong> 극값 배열(ext)과 극값 시간 배열(exttime)
        </div>
    </div>

    <div class="function-section">
        <h2>2. rainflow 함수 - Rainflow 사이클 카운팅</h2>
        <p>ASTM E 1049-85 표준에 따른 Rainflow 사이클 카운팅 알고리즘의 메인 함수입니다.</p>
        
        <div class="step">
            <div class="step-number">단계 1: 입력 검증</div>
            <ul>
                <li>극값 배열을 1차원 배열로 변환</li>
                <li>시간 정보 <code>dt</code> 유무 확인</li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 2: 함수 분기</div>
            <ul>
                <li><code>dt</code>가 없으면 → <code>_rf3()</code> 호출 (시간 정보 없음)</li>
                <li><code>dt</code>가 있으면 → <code>_rf5()</code> 호출 (시간 정보 포함)</li>
            </ul>
        </div>
    </div>

    <div class="function-section">
        <h2>3. _rf3 함수 - 시간 정보 없는 Rainflow 계산</h2>
        <p>스택 기반 알고리즘을 사용하여 사이클을 추출합니다.</p>
        
        <div class="step">
            <div class="step-number">초기화</div>
            <ul>
                <li>스택 배열 <code>a[512]</code> 생성 (극값 저장용)</li>
                <li>결과 리스트 <code>results</code> 초기화</li>
                <li>스택 포인터 <code>j = -1</code> 초기화</li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">메인 루프: 각 극값 처리</div>
            <p>모든 극값에 대해 다음 과정을 반복:</p>
            <ul>
                <li><strong>단계 3-1:</strong> 현재 극값을 스택에 추가
                    <ul>
                        <li><code>j += 1</code></li>
                        <li><code>a[j] = ext[index]</code></li>
                    </ul>
                </li>
                
                <li><strong>단계 3-2:</strong> 사이클 추출 조건 확인 (while 루프)
                    <div class="formula">
                        조건: j ≥ 2 AND |a[j-1] - a[j-2]| ≤ |a[j] - a[j-1]|
                    </div>
                    <p>이 조건은 "이전 구간의 범위가 현재 구간의 범위보다 작거나 같다"는 의미입니다.</p>
                </li>
                
                <li><strong>단계 3-3:</strong> 사이클 계산
                    <ul>
                        <li>진폭(Amplitude) 계산:
                            <div class="formula">
                                ampl = |a[j-1] - a[j-2]| / 2
                            </div>
                        </li>
                        <li>평균값(Mean) 계산:
                            <div class="formula">
                                mean = (a[j-1] + a[j-2]) / 2
                            </div>
                        </li>
                    </ul>
                </li>
                
                <li><strong>단계 3-4:</strong> 스택 상태에 따른 처리
                    <ul>
                        <li><strong>케이스 A: j == 2</strong> (스택에 3개만 있는 경우)
                            <ul>
                                <li>반사이클(half-cycle)로 처리</li>
                                <li>사이클 수 = 0.5</li>
                                <li>스택 재구성: <code>a[0] = a[1]</code>, <code>a[1] = a[2]</code>, <code>j = 1</code></li>
                            </ul>
                        </li>
                        <li><strong>케이스 B: j > 2</strong>
                            <ul>
                                <li>완전 사이클(full cycle)로 처리</li>
                                <li>사이클 수 = 1.0</li>
                                <li>스택 재구성: <code>a[j-2] = a[j]</code>, <code>j = j - 2</code></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                
                <li><strong>단계 3-5:</strong> 결과 저장
                    <ul>
                        <li>진폭이 0보다 크면 결과 리스트에 추가</li>
                        <li>형식: <code>[amplitude, mean, cycle_count]</code></li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">후처리: 남은 스택 처리</div>
            <ul>
                <li>모든 극값 처리 후 스택에 남은 점들 처리</li>
                <li>인접한 점들 간의 반사이클 계산</li>
                <li>각 쌍에 대해:
                    <div class="formula">
                        ampl = |a[i] - a[i+1]| / 2<br>
                        mean = (a[i] + a[i+1]) / 2<br>
                        cycle_count = 0.5
                    </div>
                </li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">결과 반환</div>
            <ul>
                <li>결과 리스트를 NumPy 배열로 변환</li>
                <li>형태: (3, n) 배열
                    <ul>
                        <li>행 0: 진폭(Amplitude)</li>
                        <li>행 1: 평균값(Mean)</li>
                        <li>행 2: 사이클 수(0.5 또는 1.0)</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="warning">
            <strong>알고리즘 핵심:</strong> Rainflow 알고리즘은 "비가 지붕을 타고 흐르는" 것처럼 생각하면 됩니다. 
            작은 구간이 큰 구간 안에 포함되면 작은 구간의 사이클을 먼저 추출합니다.
        </div>
    </div>

    <div class="function-section">
        <h2>4. _rf5 함수 - 시간 정보 포함 Rainflow 계산</h2>
        <p><code>_rf3</code> 함수와 유사하지만 시간 정보를 추가로 계산합니다.</p>
        
        <div class="step">
            <div class="step-number">초기화</div>
            <ul>
                <li>값 스택 배열 <code>a[512]</code> 생성</li>
                <li>시간 스택 배열 <code>t[512]</code> 생성</li>
                <li>결과 리스트 초기화</li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">메인 루프: 각 극값 처리</div>
            <ul>
                <li><strong>단계 4-1:</strong> 현재 극값과 시간을 스택에 추가
                    <ul>
                        <li><code>a[j] = ext[index]</code></li>
                        <li><code>t[j] = extt[index]</code></li>
                    </ul>
                </li>
                
                <li><strong>단계 4-2:</strong> 사이클 추출 (조건은 _rf3과 동일)</li>
                
                <li><strong>단계 4-3:</strong> 시간 정보 계산
                    <ul>
                        <li>주기(Period) 계산:
                            <div class="formula">
                                period = (t[j-1] - t[j-2]) × 2
                            </div>
                        </li>
                        <li>시작 시간(Begin Time):
                            <ul>
                                <li>j == 2인 경우: <code>atime = t[0]</code></li>
                                <li>j > 2인 경우: <code>atime = t[j-2]</code></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                
                <li><strong>단계 4-4:</strong> 스택 재구성 (값과 시간 모두 업데이트)</li>
                
                <li><strong>단계 4-5:</strong> 결과 저장
                    <ul>
                        <li>형식: <code>[amplitude, mean, cycle_count, begin_time, period]</code></li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">후처리: 남은 스택 처리</div>
            <ul>
                <li>인접한 점들 간의 반사이클 계산</li>
                <li>시간 정보 포함:
                    <div class="formula">
                        period = (t[i+1] - t[i]) × 2<br>
                        atime = t[i]
                    </div>
                </li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">결과 반환</div>
            <ul>
                <li>형태: (5, n) 배열
                    <ul>
                        <li>행 0: 진폭(Amplitude)</li>
                        <li>행 1: 평균값(Mean)</li>
                        <li>행 2: 사이클 수(0.5 또는 1.0)</li>
                        <li>행 3: 시작 시간(Begin Time)</li>
                        <li>행 4: 주기(Period)</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <div class="function-section">
        <h2>5. rfhist 함수 - 히스토그램 생성</h2>
        <p>Rainflow 결과를 히스토그램으로 시각화합니다.</p>
        
        <div class="step">
            <div class="step-number">단계 1: 데이터 타입 선택</div>
            <ul>
                <li><code>rfflag</code> 파라미터에 따라 분석할 데이터 선택:
                    <table>
                        <tr>
                            <th>플래그</th>
                            <th>데이터</th>
                            <th>행 인덱스</th>
                        </tr>
                        <tr>
                            <td>'ampl' (기본값)</td>
                            <td>진폭</td>
                            <td>0</td>
                        </tr>
                        <tr>
                            <td>'mean'</td>
                            <td>평균값</td>
                            <td>1</td>
                        </tr>
                        <tr>
                            <td>'freq'</td>
                            <td>주파수 (주기의 역수)</td>
                            <td>4 (변환됨)</td>
                        </tr>
                        <tr>
                            <td>'period'</td>
                            <td>주기</td>
                            <td>4</td>
                        </tr>
                    </table>
                </li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 2: 반사이클 식별</div>
            <ul>
                <li>사이클 수가 0.5인 항목들을 찾음</li>
                <li>이들은 나중에 보정에 사용됨</li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 3: 히스토그램 계산</div>
            <ul>
                <li><code>x</code>가 정수인 경우:
                    <ul>
                        <li>지정된 개수의 구간으로 히스토그램 생성</li>
                        <li>구간 중심값 계산</li>
                    </ul>
                </li>
                <li><code>x</code>가 배열인 경우:
                    <ul>
                        <li>지정된 구간 중심값 사용</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 4: 반사이클 보정</div>
            <ul>
                <li>전체 히스토그램에서 반사이클의 절반을 빼서 보정</li>
                <li>이유: 반사이클은 0.5로 카운트되지만 히스토그램에서는 완전 사이클로 표시되므로</li>
                <div class="formula">
                    보정된 히스토그램 = 전체 히스토그램 - 0.5 × 반사이클 히스토그램
                </div>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 5: 시각화 (선택사항)</div>
            <ul>
                <li><code>plot=True</code>인 경우 막대 그래프 생성</li>
                <li>X축: 선택된 데이터 타입</li>
                <li>Y축: 사이클 개수</li>
            </ul>
        </div>
    </div>

    <div class="function-section">
        <h2>6. rfmatrix 함수 - Rainflow 매트릭스 생성</h2>
        <p>2차원 매트릭스로 Rainflow 결과를 표현합니다.</p>
        
        <div class="step">
            <div class="step-number">단계 1: X축과 Y축 데이터 선택</div>
            <ul>
                <li><code>flagx</code>와 <code>flagy</code>에 따라 X축과 Y축에 표시할 데이터 선택</li>
                <li>가능한 조합:
                    <ul>
                        <li>X축: 진폭, Y축: 평균값 (가장 일반적)</li>
                        <li>X축: 진폭, Y축: 주파수</li>
                        <li>X축: 평균값, Y축: 주기</li>
                        <li>기타 조합</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 2: 구간(Bin) 설정</div>
            <ul>
                <li>X축과 Y축 각각에 대해:
                    <ul>
                        <li>정수인 경우: 데이터 범위를 균등하게 나눔</li>
                        <li>배열인 경우: 지정된 구간 중심값 사용</li>
                    </ul>
                </li>
                <li>구간 경계값 계산</li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 3: 매트릭스 구축</div>
            <ul>
                <li>Y축 각 구간에 대해:
                    <ul>
                        <li>해당 구간에 속하는 데이터 필터링</li>
                        <li>필터링된 데이터에 대해 X축 히스토그램 계산</li>
                        <li>결과를 매트릭스의 해당 행에 저장</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="step">
            <div class="step-number">단계 4: 3D 시각화 (선택사항)</div>
            <ul>
                <li><code>plot=True</code>인 경우 3D 막대 그래프 생성</li>
                <li>X축: flagx 데이터</li>
                <li>Y축: flagy 데이터</li>
                <li>Z축: 사이클 개수</li>
                <li>색상: 사이클 개수에 따라 그라데이션</li>
            </ul>
        </div>
    </div>

    <div class="function-section">
        <h2>전체 계산 흐름도</h2>
        <div class="step">
            <ol>
                <li><strong>신호 입력</strong> → <code>sig2ext()</code>
                    <ul>
                        <li>신호에서 극값 추출</li>
                        <li>노이즈 제거 및 정제</li>
                    </ul>
                </li>
                <li><strong>극값 배열</strong> → <code>rainflow()</code>
                    <ul>
                        <li>시간 정보 유무에 따라 <code>_rf3()</code> 또는 <code>_rf5()</code> 호출</li>
                    </ul>
                </li>
                <li><strong>Rainflow 계산</strong> → <code>_rf3()</code> 또는 <code>_rf5()</code>
                    <ul>
                        <li>스택 기반 알고리즘으로 사이클 추출</li>
                        <li>진폭, 평균값, 사이클 수 계산</li>
                        <li>(시간 정보 포함 시) 시작 시간, 주기 계산</li>
                    </ul>
                </li>
                <li><strong>결과 분석</strong> → <code>rfhist()</code> 또는 <code>rfmatrix()</code>
                    <ul>
                        <li>히스토그램: 1차원 분포 분석</li>
                        <li>매트릭스: 2차원 분포 분석</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <div class="function-section">
        <h2>알고리즘 예시</h2>
        <p>간단한 예시로 계산 과정을 설명합니다:</p>
        
        <div class="step">
            <div class="step-number">입력 신호 극값</div>
            <p>예: <code>ext = [10, 5, 15, 8, 20]</code></p>
            
            <table>
                <tr>
                    <th>단계</th>
                    <th>스택 상태</th>
                    <th>조건 확인</th>
                    <th>추출된 사이클</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>[10]</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>[10, 5]</td>
                    <td>j=1 < 2</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>[10, 5, 15]</td>
                    <td>|5-10|=5 ≤ |15-5|=10</td>
                    <td>ampl=2.5, mean=7.5, count=0.5</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>[5, 15, 8]</td>
                    <td>|15-5|=10 > |8-15|=7</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>[5, 15, 8, 20]</td>
                    <td>|8-15|=7 ≤ |20-8|=12</td>
                    <td>ampl=3.5, mean=11.5, count=1.0</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>[5, 20]</td>
                    <td>-</td>
                    <td>ampl=7.5, mean=12.5, count=0.5</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="function-section">
        <h2>주요 특징</h2>
        <ul>
            <li><strong>ASTM E 1049-85 표준 준수:</strong> 산업 표준 알고리즘 구현</li>
            <li><strong>스택 기반 알고리즘:</strong> 효율적인 메모리 사용</li>
            <li><strong>완전 사이클과 반사이클 구분:</strong> 정확한 피로 분석</li>
            <li><strong>시간 정보 지원:</strong> 주기 및 주파수 분석 가능</li>
            <li><strong>다양한 시각화:</strong> 히스토그램 및 3D 매트릭스</li>
        </ul>
    </div>

    <div class="function-section">
        <h2>응용 분야</h2>
        <ul>
            <li>구조물 피로 분석</li>
            <li>기계 부품 수명 예측</li>
            <li>진동 데이터 분석</li>
            <li>재료 시험 데이터 처리</li>
            <li>신호 처리 및 분석</li>
        </ul>
    </div>

    <footer style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; color: #777;">
        <p>Rainflow Cycle Counting Algorithm - Python Implementation</p>
        <p>원본 MATLAB 코드: Adam Nieslony (ajn@po.opole.pl)</p>
    </footer>
</body>
</html>
